{% extends "base.html" %}

{% block title %}Конструктор SQL - DB Admin Pro{% endblock %}

{% block page_title %}Конструктор SQL запросов{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Расширенный конструктор запросов</h1>
    <p class="page-description">Выполняйте SQL запросы, экспортируйте результаты и анализируйте производительность</p>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-code"></i> Редактор запросов</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">SQL запрос</label>
                <textarea id="sqlQuery" class="form-control" rows="8" 
                          placeholder="SELECT * FROM table_name WHERE condition = %s"
                          style="font-family: 'Courier New', monospace; font-size: 14px;">
{% if request.query_params.get('table') %}SELECT * FROM {{ request.query_params.get('table') }} LIMIT 200{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Параметры запроса</label>
                <div class="d-flex gap-3 mb-2">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="paramsType" value="array" checked onchange="toggleParamsType()">
                        <span>JSON массив</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="paramsType" value="object" onchange="toggleParamsType()">
                        <span>JSON объект</span>
                    </label>
                </div>
                <textarea id="sqlParams" class="form-control" rows="4" 
                          placeholder='["value1", "value2"]'
                          style="font-family: 'Courier New', monospace; font-size: 14px;"></textarea>
                <small class="form-text" id="paramsHelp">
                    Для позиционных параметров используйте массив: ["value1", "value2"]
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Формат экспорта</label>
                <select id="exportFormat" class="form-control">
                    <option value="csv">Excel (.xlsx)</option>
                    <option value="json">JSON (.json)</option>
                </select>
            </div>
            
            <div class="d-flex gap-3 mt-4">
                <button onclick="executeQuery()" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-play"></i> Выполнить
                </button>
                <button onclick="exportQueryResults()" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-download"></i> Экспорт
                </button>
                <button onclick="clearQuery()" class="btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div>
        <div class="card mb-4">
            <div class="card-header">
                <h3><i class="fas fa-database"></i> База данных</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <input type="text" id="tableSearch" class="form-control" 
                           placeholder="Поиск таблицы..." onkeyup="searchTables()">
                </div>
                <div style="max-height: 300px; overflow-y: auto; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                    <div class="grid grid-2" id="tablesGrid">
                        {% for table in tables %}
                        <div class="btn btn-secondary text-left" 
                             onclick="insertTableName('{{ table }}')"
                             style="justify-content: start; padding: 10px;">
                            <i class="fas fa-table"></i> {{ table }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-lightbulb"></i> Примеры запросов</h3>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-2">
                    <button class="btn btn-sm btn-secondary text-left" onclick="loadExample('select_all')">
                        <i class="fas fa-search"></i> SELECT * FROM customers
                    </button>
                    <button class="btn btn-sm btn-secondary text-left" onclick="loadExample('select_where_array')">
                        <i class="fas fa-filter"></i> SELECT с параметрами (массив)
                    </button>
                    <button class="btn btn-sm btn-secondary text-left" onclick="loadExample('select_where_object')">
                        <i class="fas fa-filter"></i> SELECT с параметрами (объект)
                    </button>
                    <button class="btn btn-sm btn-secondary text-left" onclick="loadExample('join')">
                        <i class="fas fa-link"></i> JOIN таблиц customers и orders
                    </button>
                    <button class="btn btn-sm btn-secondary text-left" onclick="loadExample('aggregate')">
                        <i class="fas fa-calculator"></i> Агрегатные функции
                    </button>
                    <button class="btn btn-sm btn-secondary text-left" onclick="loadExample('complex_join')">
                        <i class="fas fa-sitemap"></i> Сложный JOIN нескольких таблиц
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4" id="queryResults" style="display: none;">
    <div class="card-header d-flex justify-between align-center">
        <h3><i class="fas fa-table-list"></i> Результаты запроса</h3>
        <div>
            <span class="text-secondary mr-3">Найдено: <span id="resultCount">0</span></span>
            <span class="text-secondary">Время: <span id="executionTime">0</span> мс</span>
            <button onclick="copyResults()" class="btn btn-sm btn-secondary ml-3">
                <i class="fas fa-copy"></i> Копировать
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table id="resultsTable" class="data-table">
                <!-- Результаты будут здесь -->
            </table>
        </div>
    </div>
</div>

<div class="card mt-4" id="queryInfo" style="display: none;">
    <div class="card-header">
        <h3><i class="fas fa-info-circle"></i> Информация о запросе</h3>
    </div>
    <div class="card-body">
        <div id="queryStats" class="d-flex gap-4 mb-3"></div>
        <div id="explainResults"></div>
    </div>
</div>

<script>
// JavaScript функции остаются такими же, как в оригинале
let lastQueryTime = 0;

function insertTableName(tableName) {
    const textarea = document.getElementById('sqlQuery');
    const cursorPos = textarea.selectionStart;
    const text = textarea.value;
    textarea.value = text.substring(0, cursorPos) + tableName + text.substring(cursorPos);
    textarea.focus();
}

function searchTables() {
    const search = document.getElementById('tableSearch').value.toLowerCase();
    const tableItems = document.querySelectorAll('#tablesGrid > div');
    
    tableItems.forEach(item => {
        const tableName = item.textContent.toLowerCase();
        if (tableName.includes(search)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function toggleParamsType() {
    const paramsType = document.querySelector('input[name="paramsType"]:checked').value;
    const paramsHelp = document.getElementById('paramsHelp');
    
    if (paramsType === 'array') {
        paramsHelp.textContent = 'Для позиционных параметров используйте массив: ["value1", "value2"]';
        document.getElementById('sqlParams').placeholder = '["value1", "value2"]';
    } else {
        paramsHelp.textContent = 'Для именованных параметров используйте объект: {"param1": "value1", "param2": "value2"}';
        document.getElementById('sqlParams').placeholder = '{"param1": "value1", "param2": "value2"}';
    }
}

// ОБНОВЛЕННЫЕ ПРИМЕРЫ ДЛЯ НАШЕЙ СТРУКТУРЫ БД С РАБОЧИМИ ПАРАМЕТРАМИ
function loadExample(type) {
    const examples = {
        select_all: {
            query: "SELECT * FROM customers LIMIT 100",
            params: "[]"
        },
        select_where_array: {
            query: "SELECT * FROM products WHERE price > %s AND stock_quantity > %s ORDER BY price DESC LIMIT 20",
            params: '[10000, 5]'
        },
        select_where_object: {
            query: "SELECT * FROM orders WHERE is_paid = %(is_paid)s AND total_amount > %(min_amount)s ORDER BY order_date DESC LIMIT 15",
            params: '{"is_paid": true, "min_amount": 50000}'
        },
        join: {
            query: "SELECT o.*, c.first_name, c.last_name FROM orders o JOIN customers c ON o.customer_id = c.customer_id LIMIT 50",
            params: "[]"
        },
        aggregate: {
            query: "SELECT c.customer_id, c.first_name || ' ' || c.last_name as customer_name, COUNT(o.order_id) as total_orders, SUM(o.total_amount) as total_spent FROM customers c LEFT JOIN orders o ON c.customer_id = o.customer_id GROUP BY c.customer_id, c.first_name, c.last_name ORDER BY total_spent DESC NULLS LAST",
            params: "[]"
        },
        complex_join: {
            query: "SELECT o.order_id, o.order_date, c.first_name || ' ' || c.last_name as customer, p.product_name, oi.quantity, oi.total_price, o.total_amount FROM orders o JOIN customers c ON o.customer_id = c.customer_id JOIN order_items oi ON o.order_id = oi.order_id JOIN products p ON oi.product_id = p.product_id WHERE o.is_delivered = false ORDER BY o.order_date DESC LIMIT 50",
            params: "[]"
        },
        customers_by_id_array: {
            query: "SELECT * FROM customers WHERE customer_id IN (%s, %s, %s)",
            params: '[1, 2, 3]'
        },
        products_by_price_range_object: {
            query: "SELECT * FROM products WHERE price BETWEEN %(min_price)s AND %(max_price)s AND is_available = %(available)s ORDER BY price ASC",
            params: '{"min_price": 10000, "max_price": 50000, "available": true}'
        }
    };
    
    if (examples[type]) {
        document.getElementById('sqlQuery').value = examples[type].query;
        document.getElementById('sqlParams').value = examples[type].params;
        
        if (examples[type].params.startsWith('{')) {
            document.querySelector('input[name="paramsType"][value="object"]').checked = true;
        } else {
            document.querySelector('input[name="paramsType"][value="array"]').checked = true;
        }
        toggleParamsType();
    }
}

function clearQuery() {
    document.getElementById('sqlQuery').value = '';
    document.getElementById('sqlParams').value = '[]';
    document.getElementById('queryResults').style.display = 'none';
    document.getElementById('queryInfo').style.display = 'none';
    document.getElementById('tableSearch').value = '';
    searchTables();
}

async function executeQuery() {
    const sql = document.getElementById('sqlQuery').value.trim();
    const params = document.getElementById('sqlParams').value.trim();
    
    if (!sql) {
        alert('Введите SQL запрос');
        return;
    }
    
    const startTime = performance.now();
    
    try {
        let paramsObj = [];
        if (params) {
            try {
                const parsed = JSON.parse(params);
                // Всегда преобразуем в массив
                if (Array.isArray(parsed)) {
                    paramsObj = parsed;
                } else if (typeof parsed === 'object' && parsed !== null) {
                    // Для объекта всегда отправляем как есть - бэкенд сам разберется
                    paramsObj = parsed;
                }
            } catch (e) {
                alert('Ошибка в формате параметров JSON: ' + e.message);
                return;
            }
        }
        
        const response = await fetch('/api/query/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                sql: sql,
                params: JSON.stringify(paramsObj)
            })
        });
        
        const result = await response.json();
        const endTime = performance.now();
        lastQueryTime = Math.round(endTime - startTime);
        
        if (result.success) {
            displayResults(result.data);
            document.getElementById('resultCount').textContent = result.count;
            document.getElementById('executionTime').textContent = lastQueryTime;
            document.getElementById('queryResults').style.display = 'block';
            showQueryStats(result);
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (e) {
        alert('Ошибка: ' + e.message);
    }
}

async function exportQueryResults() {
    const sql = document.getElementById('sqlQuery').value.trim();
    const params = document.getElementById('sqlParams').value.trim();
    const format = document.getElementById('exportFormat').value;
    
    if (!sql) {
        alert('Введите SQL запрос');
        return;
    }
    
    try {
        let paramsObj = [];
        if (params) {
            try {
                const parsed = JSON.parse(params);
                // Всегда преобразуем в массив
                if (Array.isArray(parsed)) {
                    paramsObj = parsed;
                } else if (typeof parsed === 'object' && parsed !== null) {
                    // Для объекта всегда отправляем как есть - бэкенд сам разберется
                    paramsObj = parsed;
                }
            } catch (e) {
                alert('Ошибка в формате параметров JSON: ' + e.message);
                return;
            }
        }
        
        const formData = new FormData();
        formData.append('sql', sql);
        formData.append('params', JSON.stringify(paramsObj));
        formData.append('format', format);
        
        const response = await fetch('/api/query/export', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `query_result_${new Date().toISOString().slice(0,10)}`;
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            const result = await response.json();
            alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка: ' + e.message);
    }
}

function showQueryStats(result) {
    const statsDiv = document.getElementById('queryStats');
    let statsHTML = '';
    
    statsHTML += `<div><strong>Записей:</strong> ${result.count}</div>`;
    statsHTML += `<div><strong>Время:</strong> ${lastQueryTime} мс</div>`;
    
    if (result.data && result.data.length > 0) {
        const firstRow = result.data[0];
        statsHTML += `<div><strong>Колонок:</strong> ${Object.keys(firstRow).length}</div>`;
    }
    
    statsDiv.innerHTML = statsHTML;
    document.getElementById('queryInfo').style.display = 'block';
}

function displayResults(data) {
    if (!data || data.length === 0) {
        document.getElementById('resultsTable').innerHTML = 
            '<tr><td colspan="100" style="text-align: center; padding: 40px; color: var(--text-secondary);">Нет данных</td></tr>';
        return;
    }
    
    const table = document.getElementById('resultsTable');
    const headers = Object.keys(data[0]);
    
    let html = '<thead><tr>';
    headers.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '</tr></thead>';
    
    html += '<tbody>';
    data.forEach((row, index) => {
        html += '<tr>';
        headers.forEach(header => {
            let value = row[header];
            if (value === null || value === undefined) {
                value = '<span class="null-value">—</span>';
            } else if (typeof value === 'object') {
                value = '<span style="font-family: monospace; font-size: 12px; background: var(--bg-primary); padding: 4px 8px; border-radius: 4px;">' + JSON.stringify(value, null, 2) + '</span>';
            } else if (typeof value === 'string' && value.length > 100) {
                value = '<span title="' + value + '" style="cursor: help;">' + value.substring(0, 100) + '...</span>';
            } else if (typeof value === 'boolean') {
                value = value ? '✓' : '✗';
            }
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    
    table.innerHTML = html;
}

function copyResults() {
    const table = document.getElementById('resultsTable');
    let text = '';
    
    const headers = table.querySelectorAll('th');
    const headerText = Array.from(headers).map(th => th.textContent).join('\t');
    text += headerText + '\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowText = Array.from(cells).map(cell => {
            let cellText = cell.textContent || cell.innerText;
            if (cellText.includes('—')) cellText = '';
            cellText = cellText.replace(/\n/g, ' ');
            return cellText;
        }).join('\t');
        text += rowText + '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Таблица скопирована в буфер обмена');
    });
}
</script>
{% endblock %}
